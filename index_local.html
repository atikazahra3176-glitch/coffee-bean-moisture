<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Impact of Coffee Bean Moisture Synchroniser (Local)</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" />
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css" />
  <link rel="stylesheet" href="css/styles.css">
</head>
<body>
  <header class="site-header">
    <h1>Impact of Coffee Bean Moisture Synchroniser (Local)</h1>
    <p class="subtitle">Versi file tunggal - buka langsung tanpa server</p>
  </header>

  <main class="container">
    <section class="controls">
      <label for="provinceSelect">Pilih Provinsi:</label>
      <select id="provinceSelect">
        <option value="All">All</option>
      </select>
        <div class="control-buttons">
          <button id="toggleLegend" class="btn ghost" type="button">Toggle Legend</button>
          <button id="downloadCsv" class="btn" type="button">Download CSV</button>
        </div>
    </section>

    <section class="cards" id="cards">
      <div class="card" id="card-humidity">
        <h3>Humidity (%)</h3>
        <div class="value" id="cardHumidity">—</div>
      </div>
      <div class="card" id="card-normal">
        <h3>Normal (%)</h3>
        <div class="value" id="cardNormal">—</div>
      </div>
      <div class="card" id="card-over">
        <h3>Over Roast (%)</h3>
        <div class="value" id="cardOver">—</div>
      </div>
      <div class="card" id="card-risk">
        <h3>Moisture Risk Index</h3>
        <div class="value" id="cardRisk">—</div>
      </div>
    </section>

    <section class="visuals">
      <div class="chart-wrap">
        <canvas id="clusterChart"></canvas>
      </div>
      <div id="map" class="map"></div>
    </section>

    <section class="analysis-wrap">
      <h2>Analisis Kesimpulan</h2>
      <div id="analysisContent" style="background:linear-gradient(180deg,#f7fbff,#f1f7ff); padding:12px; border-radius:8px; border-left:4px solid #0ea5e9">
        <p id="analysisText">Memproses data...</p>
      </div>
    </section>

    <section class="table-wrap">
      <h2>Data Provinsi</h2>
      <table id="dataTable" class="display">
        <thead>
          <tr>
            <th>Province</th>
            <th>Humidity (%)</th>
            <th>Normal (%)</th>
            <th>Over Roast (%)</th>
            <th>Notes</th>
          </tr>
        </thead>
        <tbody id="tableBody"></tbody>
      </table>
    </section>
  </main>

  <!-- Libraries from CDN (these work when opened via file:// in modern browsers) -->
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>

  <script>
  // Inlined data (taken from data/coffee_data.json and geojson file) so file works without server
  const coffeeData = [
  {"province":"Aceh","humidity":82,"normal_pct":78,"overroast_pct":12,"notes":"High humidity, cooler areas, typical robusta regions."},
  {"province":"Sumatera Utara","humidity":73,"normal_pct":70,"overroast_pct":15,"notes":"High humidity in highlands, Arabica & Robusta mix."},
  {"province":"Sumatera Barat","humidity":76,"normal_pct":72,"overroast_pct":14,"notes":"Mountainous coffee areas with stable moisture."},
  {"province":"Riau","humidity":68,"normal_pct":64,"overroast_pct":12,"notes":"Coastal influence increases humidity variability."},
  {"province":"Jambi","humidity":71,"normal_pct":67,"overroast_pct":13,"notes":"Tropical humidity, robusta farms."},
  {"province":"Sumatera Selatan","humidity":66,"normal_pct":62,"overroast_pct":11,"notes":"Varied elevations, medium humidity."},
  {"province":"Bengkulu","humidity":70,"normal_pct":66,"overroast_pct":12,"notes":"Coastal humid climate with coffee pockets."},
  {"province":"Lampung","humidity":64,"normal_pct":60,"overroast_pct":10,"notes":"Lower humidity compared to northern Sumatra."},
  {"province":"Kepulauan Bangka Belitung","humidity":73,"normal_pct":69,"overroast_pct":13,"notes":"Maritime climate with high humidity."},
  {"province":"Kepulauan Riau","humidity":78,"normal_pct":74,"overroast_pct":12,"notes":"Very maritime, high ambient moisture."},
  {"province":"DKI Jakarta","humidity":82,"normal_pct":65,"overroast_pct":25,"notes":"Urban heat + humidity can increase overroast incidents."},
  {"province":"Jawa Barat","humidity":68,"normal_pct":66,"overroast_pct":9,"notes":"Large elevation range; many arabica farms."},
  {"province":"Jawa Tengah","humidity":66,"normal_pct":64,"overroast_pct":9,"notes":"Moderate humidity in central Java."},
  {"province":"DI Yogyakarta","humidity":65,"normal_pct":61,"overroast_pct":10,"notes":"Smaller production areas, stable humidity."},
  {"province":"Jawa Timur","humidity":60,"normal_pct":58,"overroast_pct":8,"notes":"Drier in some zones, lower humidity."},
  {"province":"Banten","humidity":75,"normal_pct":67,"overroast_pct":14,"notes":"Coastal and inland variations."},
  {"province":"Bali","humidity":69,"normal_pct":68,"overroast_pct":7,"notes":"Highland arabica with moderate humidity."},
  {"province":"Nusa Tenggara Barat","humidity":54,"normal_pct":52,"overroast_pct":6,"notes":"Drier islands, lower humidity overall."},
  {"province":"Nusa Tenggara Timur","humidity":48,"normal_pct":45,"overroast_pct":4,"notes":"One of the driest provinces, less moisture."},
  {"province":"Kalimantan Barat","humidity":85,"normal_pct":80,"overroast_pct":12,"notes":"Very humid Borneo interior regions."},
  {"province":"Kalimantan Tengah","humidity":86,"normal_pct":82,"overroast_pct":10,"notes":"Dense rainforest, high ambient humidity."},
  {"province":"Kalimantan Selatan","humidity":84,"normal_pct":78,"overroast_pct":11,"notes":"Coastal and inland humid areas."},
  {"province":"Kalimantan Timur","humidity":79,"normal_pct":74,"overroast_pct":12,"notes":"Eastern Borneo with high humidity."},
  {"province":"Kalimantan Utara","humidity":83,"normal_pct":77,"overroast_pct":11,"notes":"Northern Borneo maritime humidity."},
  {"province":"Sulawesi Utara","humidity":77,"normal_pct":73,"overroast_pct":12,"notes":"Tropical and mountainous regions."},
  {"province":"Gorontalo","humidity":75,"normal_pct":71,"overroast_pct":11,"notes":"Coastal humidity influences."},
  {"province":"Sulawesi Tengah","humidity":72,"normal_pct":68,"overroast_pct":12,"notes":"Central Sulawesi coffee areas."},
  {"province":"Sulawesi Barat","humidity":70,"normal_pct":66,"overroast_pct":12,"notes":"Smaller production, humid climate."},
  {"province":"Sulawesi Selatan","humidity":58,"normal_pct":55,"overroast_pct":9,"notes":"Drier pockets, mixed results."},
  {"province":"Sulawesi Tenggara","humidity":61,"normal_pct":57,"overroast_pct":8,"notes":"Coastal and inland mix."},
  {"province":"Maluku","humidity":88,"normal_pct":85,"overroast_pct":9,"notes":"Very high maritime humidity."},
  {"province":"Maluku Utara","humidity":86,"normal_pct":82,"overroast_pct":10,"notes":"High humidity islands."},
  {"province":"Papua Barat","humidity":90,"normal_pct":86,"overroast_pct":8,"notes":"Extremely humid rainforest climate."},
  {"province":"Papua","humidity":89,"normal_pct":85,"overroast_pct":9,"notes":"High humidity and remote coffee regions."}
];

  const geojson = {
  "type": "FeatureCollection",
  "features": [
    {"type":"Feature","properties":{"province":"Aceh"},"geometry":{"type":"Point","coordinates":[95.322,5.548]}},
    {"type":"Feature","properties":{"province":"Sumatera Utara"},"geometry":{"type":"Point","coordinates":[99.067,2.992]}},
    {"type":"Feature","properties":{"province":"Sumatera Barat"},"geometry":{"type":"Point","coordinates":[100.361,0.554]}},
    {"type":"Feature","properties":{"province":"Riau"},"geometry":{"type":"Point","coordinates":[101.706,0.507]}},
    {"type":"Feature","properties":{"province":"Jambi"},"geometry":{"type":"Point","coordinates":[103.620,-1.612]}},
    {"type":"Feature","properties":{"province":"Sumatera Selatan"},"geometry":{"type":"Point","coordinates":[104.695,-3.003]}},
    {"type":"Feature","properties":{"province":"Bengkulu"},"geometry":{"type":"Point","coordinates":[102.361,-3.799]}},
    {"type":"Feature","properties":{"province":"Lampung"},"geometry":{"type":"Point","coordinates":[105.437,-5.444]}},
    {"type":"Feature","properties":{"province":"Kepulauan Bangka Belitung"},"geometry":{"type":"Point","coordinates":[106.099,-2.740]}},
    {"type":"Feature","properties":{"province":"Kepulauan Riau"},"geometry":{"type":"Point","coordinates":[104.747,0.356]}},
    {"type":"Feature","properties":{"province":"DKI Jakarta"},"geometry":{"type":"Point","coordinates":[106.845, -6.208]}},
    {"type":"Feature","properties":{"province":"Jawa Barat"},"geometry":{"type":"Point","coordinates":[107.619,-6.903]}},
    {"type":"Feature","properties":{"province":"Jawa Tengah"},"geometry":{"type":"Point","coordinates":[110.417,-7.150]}},
    {"type":"Feature","properties":{"province":"DI Yogyakarta"},"geometry":{"type":"Point","coordinates":[110.369,-7.801]}},
    {"type":"Feature","properties":{"province":"Jawa Timur"},"geometry":{"type":"Point","coordinates":[112.752,-7.257]}},
    {"type":"Feature","properties":{"province":"Banten"},"geometry":{"type":"Point","coordinates":[106.125,-6.121]}},
    {"type":"Feature","properties":{"province":"Bali"},"geometry":{"type":"Point","coordinates":[115.188,-8.409]}},
    {"type":"Feature","properties":{"province":"Nusa Tenggara Barat"},"geometry":{"type":"Point","coordinates":[116.571,-8.652]}},
    {"type":"Feature","properties":{"province":"Nusa Tenggara Timur"},"geometry":{"type":"Point","coordinates":[122.700,-9.655]}},
    {"type":"Feature","properties":{"province":"Kalimantan Barat"},"geometry":{"type":"Point","coordinates":[109.093,-0.023]}},
    {"type":"Feature","properties":{"province":"Kalimantan Tengah"},"geometry":{"type":"Point","coordinates":[113.091,-1.669]}},
    {"type":"Feature","properties":{"province":"Kalimantan Selatan"},"geometry":{"type":"Point","coordinates":[115.489,-3.319]}},
    {"type":"Feature","properties":{"province":"Kalimantan Timur"},"geometry":{"type":"Point","coordinates":[116.845,-0.502]}},
    {"type":"Feature","properties":{"province":"Kalimantan Utara"},"geometry":{"type":"Point","coordinates":[117.784,3.352]}},
    {"type":"Feature","properties":{"province":"Sulawesi Utara"},"geometry":{"type":"Point","coordinates":[125.005,1.438]}},
    {"type":"Feature","properties":{"province":"Gorontalo"},"geometry":{"type":"Point","coordinates":[122.446,0.538]}},
    {"type":"Feature","properties":{"province":"Sulawesi Tengah"},"geometry":{"type":"Point","coordinates":[120.252,-0.901]}},
    {"type":"Feature","properties":{"province":"Sulawesi Barat"},"geometry":{"type":"Point","coordinates":[118.847,-2.898]}},
    {"type":"Feature","properties":{"province":"Sulawesi Selatan"},"geometry":{"type":"Point","coordinates":[119.436,-4.096]}},
    {"type":"Feature","properties":{"province":"Sulawesi Tenggara"},"geometry":{"type":"Point","coordinates":[122.357,-4.051]}},
    {"type":"Feature","properties":{"province":"Maluku"},"geometry":{"type":"Point","coordinates":[129.663,-3.331]}},
    {"type":"Feature","properties":{"province":"Maluku Utara"},"geometry":{"type":"Point","coordinates":[127.035,-0.356]}},
    {"type":"Feature","properties":{"province":"Papua Barat"},"geometry":{"type":"Point","coordinates":[132.990,-0.958]}},
    {"type":"Feature","properties":{"province":"Papua"},"geometry":{"type":"Point","coordinates":[138.080,-4.268]}}
  ]
};

  // The rest of the script is adapted from js/main.js but uses the inlined data
  let map; let markers = {}; let chart; let dataTable;

  function initAll() {
    initSlicer(coffeeData);
    initMap(geojson);
    initChart();
    populateTable(coffeeData);
    updateAll('All');
  }

  function initSlicer(data) {
    const sel = document.getElementById('provinceSelect');
    const provinces = data.map(d => d.province).sort();
    provinces.forEach(p => { const o = document.createElement('option'); o.value = p; o.textContent = p; sel.appendChild(o); });
    sel.addEventListener('change', e => updateAll(e.target.value));
  }

  function initMap(geojson) {
    map = L.map('map').setView([-2.5, 118], 4);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 18 }).addTo(map);

    function colorForHumidity(h) {
      const min = 30, max = 90; const ratio = Math.max(0, Math.min(1, (h - min) / (max - min)));
      const r = Math.round(255 * ratio); const g = Math.round(160 * (1 - ratio)); const b = Math.round(255 * (1 - ratio));
      return `rgb(${r},${g},${b})`;
    }

    geojson.features.forEach(f => {
      const p = f.properties.province;
      const coord = f.geometry.coordinates;
      const data = coffeeData.find(d => d.province === p);
      const hum = data ? data.humidity : 0;
      const marker = L.circleMarker([coord[1], coord[0]], { radius: 8, fillColor: colorForHumidity(hum), color: '#333', weight: 0.6, fillOpacity: 0.9 }).addTo(map);
      marker.bindPopup(`<strong>${p}</strong><br>Humidity: ${hum}%<br>Normal: ${data ? data.normal_pct : '—'}%`);
      marker.on('click', () => { document.getElementById('provinceSelect').value = p; updateAll(p); });
      markers[p] = marker;
    });
    createMapLegend();
  }

  function initChart() {
    const ctx = document.getElementById('clusterChart').getContext('2d');
    chart = new Chart(ctx, { type: 'bar', data: { labels: [], datasets: [ { label: 'Normal (%)', data: [], backgroundColor: 'rgba(75,192,192,0.8)' }, { label: 'Over Roast (%)', data: [], backgroundColor: 'rgba(255,99,132,0.8)' } ] }, options: { responsive: true, plugins: { legend: { position: 'top' } }, scales: { x: { stacked: false }, y: { beginAtZero: true, max: 100 } } } });
  }

  function updateChart(filtered) {
    const labels = filtered.map(d => d.province);
    const normal = filtered.map(d => d.normal_pct);
    const over = filtered.map(d => d.overroast_pct);
    chart.data.labels = labels; chart.data.datasets[0].data = normal; chart.data.datasets[1].data = over; chart.update();
  }

  function updateCards(filtered, selectedProvince) {
    const humidityEl = document.getElementById('cardHumidity');
    const normalEl = document.getElementById('cardNormal');
    const overEl = document.getElementById('cardOver');
    const riskEl = document.getElementById('cardRisk');

    if (selectedProvince && selectedProvince !== 'All') {
      const d = filtered[0];
      humidityEl.textContent = d ? `${d.humidity}%` : '—';
      normalEl.textContent = d ? `${d.normal_pct}%` : '—';
      overEl.textContent = d ? `${d.overroast_pct}%` : '—';
      riskEl.textContent = d ? `${((d.humidity*0.5)+(d.overroast_pct*0.5)).toFixed(1)}` : '—';
    } else {
      const avgHum = (filtered.reduce((s,d)=>s+d.humidity,0)/filtered.length).toFixed(1);
      const avgNormal = (filtered.reduce((s,d)=>s+d.normal_pct,0)/filtered.length).toFixed(1);
      const avgOver = (filtered.reduce((s,d)=>s+d.overroast_pct,0)/filtered.length).toFixed(1);
      const risk = (avgHum*0.5 + avgOver*0.5).toFixed(1);
      humidityEl.textContent = `${avgHum}%`;
      normalEl.textContent = `${avgNormal}%`;
      overEl.textContent = `${avgOver}%`;
      riskEl.textContent = `${risk}`;
    }
  }

  function populateTable(data) {
    const tbody = document.getElementById('tableBody'); tbody.innerHTML = '';
    data.forEach(d => { const tr = document.createElement('tr'); tr.innerHTML = `<td>${d.province}</td><td>${d.humidity}</td><td>${d.normal_pct}</td><td>${d.overroast_pct}</td><td>${d.notes}</td>`; tbody.appendChild(tr); });
    initTableSearch();
  }

  function updateTableFilter(selected) { if (!dataTable) return; if (selected === 'All') { dataTable.search('').draw(); } else { dataTable.search(selected).draw(); } }

  function updateMapHighlight(selected) {
    Object.keys(markers).forEach(p => {
      const m = markers[p];
      if (p === selected) { m.setStyle({ radius: 12, weight: 1.2 }); m.bringToFront(); m.openPopup(); map.setView(m.getLatLng(), 6); } else { m.setStyle({ radius: 8, weight: 0.6 }); m.closePopup(); }
    });
    if (selected === 'All') { map.setView([-2.5,118],4); }
  }

  function updateAll(selected) { const filtered = selected === 'All' ? coffeeData.slice() : coffeeData.filter(d => d.province === selected); updateChart(filtered); updateCards(filtered, selected); updateTableFilter(selected); updateMapHighlight(selected); }

  function generateAnalysis() {
    const avgOverroast = (coffeeData.reduce((s,d)=>s+d.overroast_pct,0) / coffeeData.length).toFixed(1);
    const maxOverroast = Math.max(...coffeeData.map(d=>d.overroast_pct));
    const minOverroast = Math.min(...coffeeData.map(d=>d.overroast_pct));
    const maxHumidity = Math.max(...coffeeData.map(d=>d.humidity));
    const minHumidity = Math.min(...coffeeData.map(d=>d.humidity));
    const humidityList = coffeeData.map(d=>d.humidity);
    const overroastList = coffeeData.map(d=>d.overroast_pct);
    const avgHum = humidityList.reduce((s,x)=>s+x,0)/humidityList.length;
    const avgOver = overroastList.reduce((s,x)=>s+x,0)/overroastList.length;
    const numSum = humidityList.reduce((s,h,i)=>s+(h-avgHum)*(overroastList[i]-avgOver),0);
    const denSum = Math.sqrt(humidityList.reduce((s,h)=>s+(h-avgHum)**2,0) * overroastList.reduce((s,o)=>s+(o-avgOver)**2,0));
    const correlation = (numSum / denSum).toFixed(3);
    const maxOverroastProvince = coffeeData.reduce((a,b)=>a.overroast_pct > b.overroast_pct ? a : b);
    const minOverroastProvince = coffeeData.reduce((a,b)=>a.overroast_pct < b.overroast_pct ? a : b);
    const analysisText = document.getElementById('analysisText');
    if (!analysisText) return;
    analysisText.innerHTML = `<strong>Pertanyaan:</strong> Apakah kadar air biji kopi >1% termasuk kategori over-roasted?<br><br><strong>Jawaban: <span style="color:#dc2626; font-weight:800">TIDAK</span></strong><br><br><strong>Penjelasan Berdasarkan Dataset:</strong><br>Dari analisis 34 provinsi di Indonesia, data menunjukkan:<br><br><strong>1. Definisi: Kadar Air >1% adalah NORMAL, bukan Over Roasted:</strong><br>• Kadar air 11-13% adalah standar industri untuk kopi mentah (green beans)<br>• Kadar air >1% menunjukkan kopi masih dalam kondisi fresh dan lembab<br>• <strong>Over-roasted</strong> adalah kategori hasil roasting, BUKAN kondisi kadar air penyimpanan<br>• Rata-rata Over Roast di seluruh provinsi: <strong>${avgOverroast}%</strong> (jangkauan: ${minOverroast}% - ${maxOverroast}%)<br><br><strong>2. Hubungan Kelembapan Udara dan Kadar Air pada Proses Roasting:</strong><br>Kadar air tinggi (dari kelembapan lingkungan tinggi) memengaruhi durasi roasting dan hasil akhir.<br>• Provinsi dengan humidity >80%: rata-rata over-roast ${(coffeeData.filter(d=>d.humidity>80).reduce((s,d)=>s+d.overroast_pct,0)/Math.max(1,coffeeData.filter(d=>d.humidity>80).length)).toFixed(1)}%<br>• Provinsi dengan humidity <60%: rata-rata over-roast ${(coffeeData.filter(d=>d.humidity<60).reduce((s,d)=>s+d.overroast_pct,0)/Math.max(1,coffeeData.filter(d=>d.humidity<60).length)).toFixed(1)}%<br><br><strong>3. Data Bukti:</strong><br>• Tertinggi over-roast: ${maxOverroastProvince.province} (${maxOverroastProvince.overroast_pct}%, humidity ${coffeeData.find(d=>d.province===maxOverroastProvince.province).humidity}%)<br>• Terendah over-roast: ${minOverroastProvince.province} (${minOverroastProvince.overroast_pct}%, humidity ${coffeeData.find(d=>d.province===minOverroastProvince.province).humidity}%)<br><br><strong>4. Kesimpulan:</strong><br>Kadar air >1% adalah NORMAL dan BUKAN penanda over-roasted. Namun, kadar air BUKAN faktor tunggal—kelembapan udara di setiap provinsi yang berbeda-beda juga memengaruhi kadar air penyimpanan, yang kemudian mempengaruhi durasi dan hasil roasting. Over-roasted ditentukan oleh kombinasi faktor: kadar air awal, parameter roasting, dan durasi roasting.`;
  }

  // Init when libs loaded
  window.addEventListener('load', () => { initAll(); generateAnalysis(); });
  // Setup simple controls for local page
  (function setupLocalControls(){
    const toggle = document.getElementById('toggleLegend');
    const download = document.getElementById('downloadCsv');
    if (toggle) toggle.addEventListener('click', ()=>{ const el=document.getElementById('mapLegend'); if(el) el.style.display = (el.style.display==='none')? '':'none'; });
    if (download) download.addEventListener('click', ()=>{
      const headers = ['province','humidity','normal_pct','overroast_pct','notes'];
      const rows = coffeeData.map(d => headers.map(h => `"${String(d[h]).replace(/"/g,'""')}"`).join(','));
      const csv = [headers.join(','), ...rows].join('\r\n');
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = 'coffee_data.csv'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    });
    // table sorting
    const ths = document.querySelectorAll('#dataTable thead th');
    ths.forEach((th, idx)=>{ th.style.cursor='pointer'; th.addEventListener('click', ()=>{
      const tbody = document.getElementById('tableBody'); const rows = Array.from(tbody.querySelectorAll('tr'));
      const asc = th.dataset.order !== 'asc';
      rows.sort((a,b)=>{
        const av = a.children[idx].textContent.trim(); const bv = b.children[idx].textContent.trim();
        const an = parseFloat(av.replace(/[^0-9.-]/g,'')); const bn = parseFloat(bv.replace(/[^0-9.-]/g,''));
        if(!isNaN(an) && !isNaN(bn)) return asc? an-bn : bn-an; return asc? av.localeCompare(bv) : bv.localeCompare(av);
      }); tbody.innerHTML = ''; rows.forEach(r=>tbody.appendChild(r)); ths.forEach(t=>delete t.dataset.order); th.dataset.order = asc? 'asc':'desc'; }); });
  })();
  
  function createMapLegend() {
    const el = document.getElementById('mapLegend');
    if (!el) return;
    const levels = [30,45,60,75,90];
    el.innerHTML = '<strong>Humidity (%)</strong><br/>' + levels.map(v=>{
      const min = 30, max = 90; const ratio = Math.max(0, Math.min(1, (v - min) / (max - min)));
      const r = Math.round(255 * ratio); const g = Math.round(160 * (1 - ratio)); const b = Math.round(255 * (1 - ratio));
      const color = `rgb(${r},${g},${b})`;
      return `<div style="margin-top:6px"><span class=\"legend-swatch\" style=\"background:${color}\"></span> ${v}%</div>`;
    }).join('');
  }

  function initTableSearch() {
    const input = document.getElementById('tableSearch');
    if (!input) return;
    input.addEventListener('input', e => {
      const q = (e.target.value || '').toLowerCase();
      const rows = document.querySelectorAll('#tableBody tr');
      rows.forEach(r => {
        const text = r.textContent.toLowerCase();
        r.style.display = text.indexOf(q) >= 0 ? '' : 'none';
      });
    });
  }
  </script>
</body>
</html>